<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunstream Sales Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .tab-active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39);
        }
        .kpi-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .table-row:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }
        @keyframes skeleton-loading {
            0% { background-color: rgba(255, 255, 255, 0.05); }
            100% { background-color: rgba(255, 255, 255, 0.15); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-green { background: #10b981; color: white; }
        .badge-yellow { background: #f59e0b; color: white; }
        .badge-red { background: #ef4444; color: white; }
        .badge-blue { background: #3b82f6; color: white; }
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            transition: width 0.3s ease;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .search-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s;
        }
        .search-input:focus {
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.1);
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold"></h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                        Sunstream Sales Dashboard
                    </h1>
                    <p class="text-gray-400 mt-2">Engineering & Supply Chain Solutions Intelligence</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Last Updated</div>
                    <div id="lastUpdate" class="text-lg font-semibold">--</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6 flex space-x-2 overflow-x-auto pb-2">
            <button onclick="switchTab('overview')" id="tab-overview" class="tab-active px-6 py-3 rounded-lg font-semibold whitespace-nowrap transition-all">
                üìä Overview
            </button>
            <button onclick="switchTab('companies')" id="tab-companies" class="btn-secondary px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
                üè¢ Companies
            </button>
            <button onclick="switchTab('salesrobot')" id="tab-salesrobot" class="btn-secondary px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
                ü§ñ SalesRobot
            </button>
            <button onclick="switchTab('exhibitions')" id="tab-exhibitions" class="btn-secondary px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
                üé™ Exhibitions
            </button>
            <button onclick="switchTab('decision-makers')" id="tab-decision-makers" class="btn-secondary px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
                üëî Decision Makers
            </button>
            <button onclick="switchTab('opportunities')" id="tab-opportunities" class="btn-secondary px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
                üéØ Opportunities
            </button>
            <button onclick="switchTab('news')" id="tab-news" class="btn-secondary px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
                üì∞ News & Signals
            </button>
        </div>

        <!-- Tab Content -->
        <div id="content">
            <!-- Content will be dynamically loaded here -->
        </div>
    </div>

    <script src="config.js"></script>
<script>
        // Configuration loaded from config.js (window.SSD_CONFIG)
        const CONFIG = window.SSD_CONFIG || {};

        // State
        let currentTab = 'overview';
        let cache = {};
        let currentPage = { companies: 0, exhibitions: 0, decisionMakers: 0, opportunities: 0 };
        const PAGE_SIZE = 25;

        // SalesRobot cache - pre-fetched on load, always ready
        let salesRobotCache = { campaigns: [], lastFetched: null, loading: false };

        async function prefetchSalesRobot() {
            if (salesRobotCache.loading) return;
            salesRobotCache.loading = true;
            try {
                let allCampaigns = [];
                for (const account of (CONFIG.ACCOUNTS || [])) {
                    const campaigns = await fetchSalesRobot(`/api/campaigns?linkedinAccountUuid=${account.uuid}`);
                    campaigns.forEach(c => { c.accountName = account.name; allCampaigns.push(c); });
                }
                salesRobotCache.campaigns = allCampaigns;
                salesRobotCache.lastFetched = new Date();
                console.log('SalesRobot data cached:', allCampaigns.length, 'campaigns');
            } catch(e) { console.error('SalesRobot prefetch error:', e); }
            salesRobotCache.loading = false;
        }

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // API Functions
        async function fetchSupabase(table, options = {}) {
            if (!CONFIG.SUPABASE_URL) {
                console.error('CONFIG not loaded yet. Retrying in 2s...');
                await new Promise(r => setTimeout(r, 2000));
                if (window.SSD_CONFIG) Object.assign(CONFIG, window.SSD_CONFIG);
                if (!CONFIG.SUPABASE_URL) { showToast('Config not loaded. Refresh the page.', 'error'); return []; }
            }
            const { limit = 1000, offset = 0, select = '*', filters = [], order, count = false } = options;
            let url = `${CONFIG.SUPABASE_URL}/rest/v1/${table}?select=${select}`;
            
            if (limit) url += `&limit=${limit}`;
            if (offset) url += `&offset=${offset}`;
            if (order) url += `&order=${order}`;
            filters.forEach(f => url += `&${f}`);

            const headers = {
                'apikey': CONFIG.SUPABASE_KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
            };
            if (count) headers['Prefer'] = 'count=exact';

            try {
                const response = await fetch(url, { headers });
                if (!response.ok) { console.error('Supabase error:', response.status, await response.text()); return count ? { data: [], count: 0 } : []; }
                const data = await response.json();
                if (count) {
                    const range = response.headers.get('content-range');
                    const total = range ? parseInt(range.split('/')[1]) : data.length;
                    return { data, count: total };
                }
                return data;
            } catch(e) { console.error('Fetch error for', table, e); showToast(`Failed to load ${table}`, 'error'); return count ? { data: [], count: 0 } : []; }
        }

        async function fetchSalesRobot(endpoint) {
            if (!CONFIG.SALESROBOT_API) return [];
            try {
                const response = await fetch(`${CONFIG.SALESROBOT_API}${endpoint}`, {
                    headers: { 'authorization': CONFIG.SALESROBOT_KEY }
                });
                if (!response.ok) { console.error('SalesRobot error:', response.status); return []; }
                return await response.json();
            } catch(e) { console.error('SalesRobot fetch error:', e); return []; }
        }

        async function generateAIContent(prompt, maxTokens = 500) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.OPENAI_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: 'You are a B2B sales assistant for Sunstream Global, an engineering and supply chain solutions company specializing in Plant Engineering, Product Engineering, and Environmental Compliance.' },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: maxTokens
                    })
                });
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('AI Generation Error:', error);
                return null;
            }
        }

        // Tab Switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('btn-secondary');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('btn-secondary');

            // Load tab content
            loadTabContent(tab);
        }

        async function loadTabContent(tab) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center items-center h-64"><div class="spinner"></div></div>';

            switch(tab) {
                case 'overview': await loadOverview(); break;
                case 'companies': await loadCompanies(); break;
                case 'salesrobot': await loadSalesRobot(); break;
                case 'exhibitions': await loadExhibitions(); break;
                case 'decision-makers': await loadDecisionMakers(); break;
                case 'opportunities': await loadOpportunities(); break;
                case 'news': await loadNews(); break;
            }

            updateTimestamp();
        }

        // TAB 1: OVERVIEW
        async function loadOverview() {
            const content = document.getElementById('content');
            
            // Fetch counts efficiently using Supabase count headers (no need to download all rows)
            const [companiesResult, employeesResult, dmResult, exhibitionsResult, exhibitorsResult] = await Promise.all([
                fetchSupabase('companies', { select: 'id', limit: 1, count: true }),
                fetchSupabase('employees', { select: 'id', limit: 1, count: true }),
                fetchSupabase('employees', { select: 'id', limit: 1, count: true, filters: ['is_decision_maker=eq.true'] }),
                fetchSupabase('exhibitions', { select: 'id', limit: 1, count: true }),
                fetchSupabase('exhibition_exhibitors', { select: 'id', limit: 1, count: true })
            ]);

            const companies = { length: companiesResult.count || 0 };
            const employees = { length: employeesResult.count || 0 };
            const decisionMakers = { length: dmResult.count || 0 };
            const exhibitions = { length: exhibitionsResult.count || 0 };
            const exhibitors = { length: exhibitorsResult.count || 0 };
            
            // Use cached SalesRobot data (pre-fetched on page load)
            let totalProspects = 0, totalSent = 0, totalAccepted = 0, totalReplies = 0;
            salesRobotCache.campaigns.forEach(c => {
                totalProspects += c.totalProspects || 0;
                totalSent += c.totalSent || 0;
                totalAccepted += c.totalAccepted || 0;
                totalReplies += c.totalReplies || 0;
            });

            const acceptRate = totalSent > 0 ? ((totalAccepted / totalSent) * 100).toFixed(1) : 0;
            const replyRate = totalSent > 0 ? ((totalReplies / totalSent) * 100).toFixed(1) : 0;

            content.innerHTML = `
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Total Companies</div>
                        <div class="text-3xl font-bold text-blue-400">${companies.length.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Decision Makers</div>
                        <div class="text-3xl font-bold text-emerald-400">${decisionMakers.length.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Exhibitions</div>
                        <div class="text-3xl font-bold text-purple-400">${exhibitions.length}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Active Campaigns</div>
                        <div class="text-3xl font-bold text-yellow-400">15</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Total Prospects</div>
                        <div class="text-3xl font-bold text-orange-400">${totalProspects.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Accept Rate</div>
                        <div class="text-3xl font-bold text-green-400">${acceptRate}%</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Reply Rate</div>
                        <div class="text-3xl font-bold text-cyan-400">${replyRate}%</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="kpi-card p-6 rounded-xl">
                        <h3 class="text-xl font-bold mb-4">Pipeline Funnel</h3>
                        <canvas id="funnelChart"></canvas>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <h3 class="text-xl font-bold mb-4">SalesRobot Performance</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="kpi-card p-6 rounded-xl">
                    <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3 p-3 bg-white bg-opacity-5 rounded-lg">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-semibold">New decision maker identified</div>
                                <div class="text-sm text-gray-400">VP Engineering at Sunstream prospect</div>
                            </div>
                            <div class="text-sm text-gray-400">2 min ago</div>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-white bg-opacity-5 rounded-lg">
                            <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-semibold">Campaign update</div>
                                <div class="text-sm text-gray-400">15 new connection requests accepted</div>
                            </div>
                            <div class="text-sm text-gray-400">1 hour ago</div>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-white bg-opacity-5 rounded-lg">
                            <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-semibold">Exhibition data updated</div>
                                <div class="text-sm text-gray-400">125 new exhibitors added</div>
                            </div>
                            <div class="text-sm text-gray-400">3 hours ago</div>
                        </div>
                    </div>
                </div>
            `;

            // Render charts
            new Chart(document.getElementById('funnelChart'), {
                type: 'bar',
                data: {
                    labels: ['New', 'Contacted', 'Qualified', 'Meeting', 'Proposal', 'Won'],
                    datasets: [{
                        label: 'Companies',
                        data: [24036, 5200, 2800, 850, 320, 120],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, scales: { y: { ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#9ca3af' } } } }
            });

            new Chart(document.getElementById('performanceChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Sent', 'Accepted', 'Replied'],
                    datasets: [{
                        data: [totalSent, totalAccepted, totalReplies],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { labels: { color: '#9ca3af' } } } }
            });
        }

        // TAB 2: COMPANIES
        async function loadCompanies(page = 0, searchTerm = '', filters = {}) {
            currentPage.companies = page;
            const content = document.getElementById('content');
            
            const offset = page * PAGE_SIZE;
            const filterArray = [];
            if (filters.country) filterArray.push(`headquarters_country=eq.${filters.country}`);
            if (filters.status) filterArray.push(`engagement_status=eq.${filters.status}`);
            if (searchTerm) filterArray.push(`name=ilike.*${searchTerm}*`);
            
            const result = await fetchSupabase('companies', { 
                limit: PAGE_SIZE, 
                offset, 
                order: 'name.asc',
                filters: filterArray,
                count: true
            });

            const companies = result.data || result;
            const totalCompanies = result.count || companies.length;

            // Get exhibition + DM counts only for the visible companies (not all 24K)
            const companyIds = companies.map(c => c.id);
            let exhibitionCounts = {};
            let dmCounts = {};
            if (companyIds.length > 0) {
                const idList = companyIds.map(id => `"${id}"`).join(',');
                const [exhibitors, employees] = await Promise.all([
                    fetchSupabase('exhibition_exhibitors', { select: 'company_id', filters: [`company_id=in.(${idList})`], limit: 5000 }),
                    fetchSupabase('employees', { select: 'company_id,is_decision_maker', filters: [`company_id=in.(${idList})`, 'is_decision_maker=eq.true'], limit: 5000 })
                ]);
                exhibitors.forEach(ex => { exhibitionCounts[ex.company_id] = (exhibitionCounts[ex.company_id] || 0) + 1; });
                employees.forEach(emp => { dmCounts[emp.company_id] = (dmCounts[emp.company_id] || 0) + 1; });
            }

            content.innerHTML = `
                <div class="kpi-card p-6 rounded-xl mb-6">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="companySearch" placeholder="üîç Search companies..." 
                            class="search-input flex-1" value="${searchTerm}"
                            onkeyup="if(event.key==='Enter') loadCompanies(0, this.value)">
                        <button onclick="exportCSV('companies')" class="btn btn-secondary">üì• Export CSV</button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-3">Company Name</th>
                                    <th class="text-left p-3">Country</th>
                                    <th class="text-left p-3">Size</th>
                                    <th class="text-left p-3">Industry</th>
                                    <th class="text-left p-3">Exhibitions</th>
                                    <th class="text-left p-3">Decision Makers</th>
                                    <th class="text-left p-3">Status</th>
                                    <th class="text-left p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="companiesTableBody">
                                ${companies.map(c => `
                                    <tr class="table-row border-b border-gray-800 cursor-pointer" onclick="viewCompanyDetails('${c.id}')">
                                        <td class="p-3 font-semibold text-blue-400">${c.name || 'N/A'}</td>
                                        <td class="p-3">${c.headquarters_country || 'N/A'}</td>
                                        <td class="p-3">${c.company_size_range || 'N/A'}</td>
                                        <td class="p-3 text-sm">${Array.isArray(c.industries) ? c.industries.slice(0,2).join(', ') : (c.industries || 'N/A')}</td>
                                        <td class="p-3"><span class="badge badge-blue">${exhibitionCounts[c.id] || 0}</span></td>
                                        <td class="p-3"><span class="badge badge-green">${dmCounts[c.id] || 0}</span></td>
                                        <td class="p-3"><span class="badge ${c.engagement_status === 'contacted' ? 'badge-yellow' : 'badge-blue'}">${c.engagement_status || 'new'}</span></td>
                                        <td class="p-3" onclick="event.stopPropagation()">
                                            <button onclick="generateEmail('${c.id}', 'company')" class="btn btn-primary text-xs mr-2">üìß Email</button>
                                            ${c.linkedin_url ? `<a href="${c.linkedin_url}" target="_blank" class="btn btn-secondary text-xs">üîó LinkedIn</a>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex justify-between items-center mt-6">
                        <div class="text-gray-400">
                            Showing ${offset + 1}-${Math.min(offset + PAGE_SIZE, totalCompanies)} of ${totalCompanies.toLocaleString()} companies
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadCompanies(${page - 1}, document.getElementById('companySearch').value)" 
                                ${page === 0 ? 'disabled' : ''} class="btn btn-secondary">‚Üê Previous</button>
                            <span class="px-3 py-2 text-gray-400">Page ${page + 1} of ${Math.ceil(totalCompanies / PAGE_SIZE)}</span>
                            <button onclick="loadCompanies(${page + 1}, document.getElementById('companySearch').value)" 
                                ${offset + PAGE_SIZE >= totalCompanies ? 'disabled' : ''} class="btn btn-secondary">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function viewCompanyDetails(companyId) {
            const [company] = await fetchSupabase('companies', { filters: [`id=eq.${companyId}`] });
            const employees = await fetchSupabase('employees', { filters: [`company_id=eq.${companyId}`], limit: 100 });
            const exhibitors = await fetchSupabase('exhibition_exhibitors', { 
                select: 'exhibition_id,exhibitions(name,event_date_start)',
                filters: [`company_id=eq.${companyId}`] 
            });

            showModal(company.name, `
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-lg mb-2">Company Details</h3>
                        <p><strong>Website:</strong> ${company.website_url ? `<a href="${company.website_url}" target="_blank" class="text-blue-400 hover:underline">${company.website_url}</a>` : 'N/A'}</p>
                        <p><strong>LinkedIn:</strong> ${company.linkedin_url ? `<a href="${company.linkedin_url}" target="_blank" class="text-blue-400 hover:underline">${company.linkedin_url}</a>` : 'N/A'}</p>
                        <p><strong>Country:</strong> ${company.headquarters_country || 'N/A'}</p>
                        <p><strong>Size:</strong> ${company.company_size_range || 'N/A'}</p>
                        <p><strong>Industries:</strong> ${Array.isArray(company.industries) ? company.industries.join(', ') : (company.industries || 'N/A')}</p>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-2">Employees (${employees.length})</h3>
                        <div class="max-h-96 overflow-y-auto">
                            ${employees.map(e => `
                                <div class="p-3 bg-white bg-opacity-5 rounded-lg mb-2 hover:bg-opacity-10 transition-all">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <div class="font-semibold text-lg">${e.first_name} ${e.last_name} ${e.is_decision_maker ? '‚≠ê' : ''}</div>
                                            <div class="text-sm text-gray-400">${e.title || 'N/A'}</div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                <span class="badge badge-blue mr-1">${e.seniority_level || 'N/A'}</span>
                                                ${e.email ? `<span class="mr-2">üìß ${e.email}</span>` : ''}
                                                ${e.phone ? `<span>üì± ${e.phone}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        ${e.email ? `<button onclick="generateEmail('${e.id}', 'employee', '${e.email}', '${e.first_name} ${e.last_name}', '${e.title || ''}', '${company.name}')" class="btn btn-primary text-xs">üìß Email</button>` : ''}
                                        ${e.linkedin_url ? `<a href="${e.linkedin_url}" target="_blank" class="btn btn-secondary text-xs">üîó LinkedIn</a>` : ''}
                                        ${e.linkedin_url ? `<button onclick="generateLinkedIn('${e.linkedin_url}', '${e.first_name} ${e.last_name}', '${e.title || ''}')" class="btn btn-secondary text-xs">üí¨ InMail</button>` : ''}
                                        ${e.phone ? `<a href="tel:${e.phone}" class="btn btn-secondary text-xs">üì± Call</a>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-2">Exhibitions Attended (${exhibitors.length})</h3>
                        <div class="max-h-48 overflow-y-auto">
                            ${exhibitors.map(ex => `
                                <div class="p-2 bg-white bg-opacity-5 rounded mb-2">
                                    <div class="font-semibold">${ex.exhibitions?.name || 'N/A'}</div>
                                    <div class="text-xs text-gray-400">${ex.exhibitions?.event_date_start ? new Date(ex.exhibitions.event_date_start).toLocaleDateString() : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `);
        }

        // TAB 3: SALESROBOT
        async function loadSalesRobot(forceRefresh = false) {
            const content = document.getElementById('content');
            
            // Use cache if available and not forcing refresh
            if (!forceRefresh && salesRobotCache.lastFetched && salesRobotCache.campaigns.length > 0) {
                renderSalesRobot(salesRobotCache.campaigns);
                return;
            }
            
            // Show spinner only on first load or force refresh
            if (!salesRobotCache.lastFetched) {
                content.innerHTML = '<div class="flex justify-center items-center h-64"><div class="spinner"></div><span class="ml-4 text-gray-400">Fetching SalesRobot campaigns...</span></div>';
            }

            await prefetchSalesRobot();
            renderSalesRobot(salesRobotCache.campaigns);
        }

        function renderSalesRobot(allCampaigns) {
            const content = document.getElementById('content');

            const activeAccounts = CONFIG.ACCOUNTS.length;
            const activeCampaigns = allCampaigns.filter(c => c.status === 'active').length;
            const totalProspects = allCampaigns.reduce((sum, c) => sum + (c.totalProspects || 0), 0);
            const totalSent = allCampaigns.reduce((sum, c) => sum + (c.totalSent || 0), 0);
            const totalAccepted = allCampaigns.reduce((sum, c) => sum + (c.totalAccepted || 0), 0);
            const avgAcceptRate = totalSent > 0 ? ((totalAccepted / totalSent) * 100).toFixed(1) : 0;

            content.innerHTML = `
                <!-- Header with Refresh -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">SalesRobot Campaigns</h2>
                        <span class="text-sm text-gray-400">${salesRobotCache.lastFetched ? 'Last updated: ' + salesRobotCache.lastFetched.toLocaleTimeString() : 'Loading...'}</span>
                    </div>
                    <button onclick="loadSalesRobot(true)" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-semibold transition-all">
                        üîÑ Refresh Data
                    </button>
                </div>

                <!-- Account Summary -->
                <div class="grid md:grid-cols-5 gap-4 mb-6">
                    ${CONFIG.ACCOUNTS.map(acc => `
                        <div class="kpi-card p-4 rounded-xl text-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl font-bold">
                                ${acc.name.charAt(0)}
                            </div>
                            <div class="font-bold">${acc.name}</div>
                            <div class="text-sm text-gray-400">Active</div>
                        </div>
                    `).join('')}
                </div>

                <!-- Aggregate Stats -->
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Active Campaigns</div>
                        <div class="text-3xl font-bold text-blue-400">${activeCampaigns}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Total Prospects</div>
                        <div class="text-3xl font-bold text-purple-400">${totalProspects.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Messages Sent</div>
                        <div class="text-3xl font-bold text-orange-400">${totalSent.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Avg Accept Rate</div>
                        <div class="text-3xl font-bold text-green-400">${avgAcceptRate}%</div>
                    </div>
                </div>

                <!-- Campaigns Table -->
                <div class="kpi-card p-6 rounded-xl">
                    <h3 class="text-xl font-bold mb-4">All Campaigns</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-3">Account</th>
                                    <th class="text-left p-3">Campaign</th>
                                    <th class="text-left p-3">Status</th>
                                    <th class="text-left p-3">Prospects</th>
                                    <th class="text-left p-3">Sent</th>
                                    <th class="text-left p-3">Accepted</th>
                                    <th class="text-left p-3">Accept %</th>
                                    <th class="text-left p-3">Replies</th>
                                    <th class="text-left p-3">Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allCampaigns.map(c => {
                                    const acceptRate = c.totalSent > 0 ? ((c.totalAccepted / c.totalSent) * 100).toFixed(1) : 0;
                                    const progress = c.totalProspects > 0 ? ((c.totalSent / c.totalProspects) * 100).toFixed(0) : 0;
                                    const rateColor = acceptRate > 10 ? 'badge-green' : acceptRate > 5 ? 'badge-yellow' : 'badge-red';
                                    
                                    return `
                                        <tr class="table-row border-b border-gray-800">
                                            <td class="p-3 font-semibold">${c.accountName}</td>
                                            <td class="p-3">${c.name || 'Unnamed Campaign'}</td>
                                            <td class="p-3"><span class="badge ${c.status === 'active' ? 'badge-green' : 'badge-yellow'}">${c.status || 'N/A'}</span></td>
                                            <td class="p-3">${c.totalProspects || 0}</td>
                                            <td class="p-3">${c.totalSent || 0}</td>
                                            <td class="p-3">${c.totalAccepted || 0}</td>
                                            <td class="p-3"><span class="badge ${rateColor}">${acceptRate}%</span></td>
                                            <td class="p-3">${c.totalReplies || 0}</td>
                                            <td class="p-3">
                                                <div class="progress-bar">
                                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                                </div>
                                                <div class="text-xs text-gray-400 mt-1">${progress}%</div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // TAB 4: EXHIBITIONS
        async function loadExhibitions(page = 0, searchTerm = '') {
            currentPage.exhibitions = page;
            const content = document.getElementById('content');
            
            const offset = page * PAGE_SIZE;
            let exhibitions = await fetchSupabase('exhibitions', { 
                limit: PAGE_SIZE, 
                offset,
                order: 'event_date_start.desc'
            });

            if (searchTerm) {
                exhibitions = exhibitions.filter(ex => 
                    ex.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    ex.venue_name?.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Get company counts per exhibition
            const exhibitors = await fetchSupabase('exhibition_exhibitors', { select: 'exhibition_id' });
            const companyCounts = {};
            exhibitors.forEach(ex => {
                companyCounts[ex.exhibition_id] = (companyCounts[ex.exhibition_id] || 0) + 1;
            });

            content.innerHTML = `
                <div class="kpi-card p-6 rounded-xl">
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="exhibitionSearch" placeholder="üîç Search exhibitions..." 
                            class="search-input flex-1" value="${searchTerm}"
                            onkeyup="if(event.key==='Enter') loadExhibitions(0, this.value)">
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-3">Exhibition Name</th>
                                    <th class="text-left p-3">Venue</th>
                                    <th class="text-left p-3">Start Date</th>
                                    <th class="text-left p-3">End Date</th>
                                    <th class="text-left p-3">Companies</th>
                                    <th class="text-left p-3">Status</th>
                                    <th class="text-left p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${exhibitions.map(ex => `
                                    <tr class="table-row border-b border-gray-800">
                                        <td class="p-3 font-semibold text-blue-400 cursor-pointer" onclick="viewExhibitionDetails('${ex.id}')">${ex.name || 'N/A'}</td>
                                        <td class="p-3">${ex.venue_name || 'N/A'}</td>
                                        <td class="p-3">${ex.event_date_start ? new Date(ex.event_date_start).toLocaleDateString() : 'N/A'}</td>
                                        <td class="p-3">${ex.event_date_end ? new Date(ex.event_date_end).toLocaleDateString() : 'N/A'}</td>
                                        <td class="p-3"><span class="badge badge-blue">${companyCounts[ex.id] || 0}</span></td>
                                        <td class="p-3"><span class="badge ${ex.status === 'completed' ? 'badge-green' : 'badge-yellow'}">${ex.status || 'upcoming'}</span></td>
                                        <td class="p-3">
                                            <button onclick="viewExhibitionDetails('${ex.id}')" class="btn btn-primary text-xs">View Details</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center mt-6">
                        <div class="text-gray-400">
                            Showing ${offset + 1}-${Math.min(offset + PAGE_SIZE, offset + exhibitions.length)} exhibitions
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadExhibitions(${page - 1}, document.getElementById('exhibitionSearch').value)" 
                                ${page === 0 ? 'disabled' : ''} class="btn btn-secondary">‚Üê Previous</button>
                            <button onclick="loadExhibitions(${page + 1}, document.getElementById('exhibitionSearch').value)" 
                                ${exhibitions.length < PAGE_SIZE ? 'disabled' : ''} class="btn btn-secondary">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function viewExhibitionDetails(exhibitionId) {
            const [exhibition] = await fetchSupabase('exhibitions', { filters: [`id=eq.${exhibitionId}`] });
            const exhibitors = await fetchSupabase('exhibition_exhibitors', { 
                select: 'company_id,companies(name,website_url,headquarters_country)',
                filters: [`exhibition_id=eq.${exhibitionId}`] 
            });

            showModal(exhibition.name, `
                <div class="space-y-4">
                    <div>
                        <p><strong>Venue:</strong> ${exhibition.venue_name || 'N/A'}</p>
                        <p><strong>Dates:</strong> ${exhibition.event_date_start ? new Date(exhibition.event_date_start).toLocaleDateString() : 'N/A'} - ${exhibition.event_date_end ? new Date(exhibition.event_date_end).toLocaleDateString() : 'N/A'}</p>
                        <p><strong>Expected Exhibitors:</strong> ${exhibition.expected_exhibitors || 'N/A'}</p>
                        <p><strong>Status:</strong> ${exhibition.status || 'N/A'}</p>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-2">Exhibiting Companies (${exhibitors.length})</h3>
                        <div class="max-h-64 overflow-y-auto">
                            ${exhibitors.slice(0, 20).map(ex => `
                                <div class="p-2 bg-white bg-opacity-5 rounded mb-2">
                                    <div class="font-semibold">${ex.companies?.name || 'N/A'}</div>
                                    <div class="text-sm text-gray-400">${ex.companies?.headquarters_country || 'N/A'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `);
        }

        // TAB 5: DECISION MAKERS
        async function loadDecisionMakers(page = 0, searchTerm = '', filters = {}) {
            currentPage.decisionMakers = page;
            const content = document.getElementById('content');
            
            const offset = page * PAGE_SIZE;
            const filterArray = ['is_decision_maker=eq.true'];
            if (filters.seniority) filterArray.push(`seniority_level=eq.${filters.seniority}`);
            
            let decisionMakers = await fetchSupabase('employees', { 
                limit: PAGE_SIZE, 
                offset,
                select: '*,companies(name)',
                filters: filterArray,
                order: 'first_name.asc'
            });

            if (searchTerm) {
                decisionMakers = decisionMakers.filter(dm => 
                    dm.first_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    dm.last_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    dm.title?.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Seniority breakdown
            const allDMs = await fetchSupabase('employees', { filters: ['is_decision_maker=eq.true'], select: 'seniority_level' });
            const seniorityCount = {};
            allDMs.forEach(dm => {
                const level = dm.seniority_level || 'Unknown';
                seniorityCount[level] = (seniorityCount[level] || 0) + 1;
            });

            content.innerHTML = `
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    ${Object.entries(seniorityCount).slice(0, 4).map(([level, count]) => `
                        <div class="kpi-card p-4 rounded-xl">
                            <div class="text-gray-400 text-sm mb-2">${level}</div>
                            <div class="text-2xl font-bold text-blue-400">${count}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="kpi-card p-6 rounded-xl">
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="dmSearch" placeholder="üîç Search decision makers..." 
                            class="search-input flex-1" value="${searchTerm}"
                            onkeyup="if(event.key==='Enter') loadDecisionMakers(0, this.value)">
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-3">Name</th>
                                    <th class="text-left p-3">Title</th>
                                    <th class="text-left p-3">Company</th>
                                    <th class="text-left p-3">Seniority</th>
                                    <th class="text-left p-3">Email</th>
                                    <th class="text-left p-3">Phone</th>
                                    <th class="text-left p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${decisionMakers.map(dm => `
                                    <tr class="table-row border-b border-gray-800">
                                        <td class="p-3 font-semibold">${dm.first_name} ${dm.last_name}</td>
                                        <td class="p-3 text-sm">${dm.title || 'N/A'}</td>
                                        <td class="p-3">${dm.companies?.name || 'N/A'}</td>
                                        <td class="p-3"><span class="badge badge-blue">${dm.seniority_level || 'N/A'}</span></td>
                                        <td class="p-3 text-sm">${dm.email || 'N/A'}</td>
                                        <td class="p-3 text-sm">${dm.phone ? `<a href="tel:${dm.phone}" class="text-blue-400">${dm.phone}</a>` : 'N/A'}</td>
                                        <td class="p-3">
                                            ${dm.email ? `<button onclick="generateEmail('${dm.id}', 'contact', '${dm.email}', '${dm.first_name} ${dm.last_name}', '${dm.title}', '${dm.companies?.name}')" class="btn btn-primary text-xs mr-2">üìß</button>` : ''}
                                            ${dm.linkedin_url ? `<button onclick="generateLinkedIn('${dm.linkedin_url}', '${dm.first_name} ${dm.last_name}', '${dm.title}')" class="btn btn-secondary text-xs">üîó</button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center mt-6">
                        <div class="text-gray-400">
                            Showing ${offset + 1}-${Math.min(offset + PAGE_SIZE, offset + decisionMakers.length)} decision makers
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadDecisionMakers(${page - 1}, document.getElementById('dmSearch').value)" 
                                ${page === 0 ? 'disabled' : ''} class="btn btn-secondary">‚Üê Previous</button>
                            <button onclick="loadDecisionMakers(${page + 1}, document.getElementById('dmSearch').value)" 
                                ${decisionMakers.length < PAGE_SIZE ? 'disabled' : ''} class="btn btn-secondary">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // TAB 6: OPPORTUNITIES
        let opportunitiesCache = { hot: [], warm: [], cold: [], loaded: false };
        let opportunitiesState = { page: 0, filter: 'All' };

        async function loadOpportunities(page = 0, filter = 'All') {
            const content = document.getElementById('content');
            opportunitiesState = { page, filter };

            // Load data if not cached
            if (!opportunitiesCache.loaded) {
                content.innerHTML = '<div class="flex justify-center items-center h-64"><div class="spinner"></div><span class="ml-4 text-gray-400">Loading 200+ opportunities...</span></div>';

                // Fetch all data needed
                const [exhibitors, employees, companies] = await Promise.all([
                    fetchSupabase('exhibition_exhibitors', { select: 'company_id,exhibition_id', limit: 50000 }),
                    fetchSupabase('employees', { select: 'company_id,is_decision_maker,email,phone', limit: 50000 }),
                    fetchSupabase('companies', { select: 'id,name,website_url,linkedin_url,headquarters_country,company_size_range,industries', limit: 50000 })
                ]);

                // Calculate exhibition counts per company
                const exhibitionCounts = {};
                exhibitors.forEach(ex => {
                    exhibitionCounts[ex.company_id] = (exhibitionCounts[ex.company_id] || 0) + 1;
                });

                // Calculate decision maker info per company
                const dmInfo = {};
                employees.forEach(emp => {
                    if (!emp.company_id) return;
                    if (!dmInfo[emp.company_id]) {
                        dmInfo[emp.company_id] = { count: 0, hasEmail: false, hasPhone: false };
                    }
                    if (emp.is_decision_maker) {
                        dmInfo[emp.company_id].count++;
                        if (emp.email) dmInfo[emp.company_id].hasEmail = true;
                        if (emp.phone) dmInfo[emp.company_id].hasPhone = true;
                    }
                });

                // Categorize opportunities
                opportunitiesCache.hot = [];
                opportunitiesCache.warm = [];
                opportunitiesCache.cold = [];
                
                companies.forEach(c => {
                    const exCount = exhibitionCounts[c.id] || 0;
                    const dm = dmInfo[c.id] || { count: 0, hasEmail: false, hasPhone: false };
                    
                    if (exCount === 0 && dm.count === 0) return; // Skip companies with no data

                    const opportunity = {
                        ...c,
                        exhibitionCount: exCount,
                        dmCount: dm.count,
                        hasEmail: dm.hasEmail,
                        hasPhone: dm.hasPhone,
                        contactPct: dm.count > 0 ? Math.round(((dm.hasEmail ? 1 : 0) + (dm.hasPhone ? 1 : 0)) / 2 * 100) : 0
                    };

                    // Classification logic
                    if (exCount >= 3 && dm.count > 0 && (dm.hasEmail || dm.hasPhone)) {
                        opportunitiesCache.hot.push(opportunity);
                    } else if (exCount >= 2 || dm.count > 0) {
                        opportunitiesCache.warm.push(opportunity);
                    } else {
                        opportunitiesCache.cold.push(opportunity);
                    }
                });

                opportunitiesCache.loaded = true;
            }

            renderOpportunities();
        }

        function renderOpportunities() {
            const content = document.getElementById('content');
            const { page, filter } = opportunitiesState;
            const { hot, warm, cold } = opportunitiesCache;

            // Select data based on filter
            let displayData = [];
            if (filter === 'All') {
                displayData = [...hot, ...warm, ...cold];
            } else if (filter === 'Hot') {
                displayData = hot;
            } else if (filter === 'Warm') {
                displayData = warm;
            } else if (filter === 'Cold') {
                displayData = cold;
            }

            const totalOpps = displayData.length;
            const offset = page * PAGE_SIZE;
            const paginatedData = displayData.slice(offset, offset + PAGE_SIZE);

            const totalWithEmail = [...hot, ...warm, ...cold].filter(o => o.hasEmail).length;
            const totalWithPhone = [...hot, ...warm, ...cold].filter(o => o.hasPhone).length;
            const allOpps = hot.length + warm.length + cold.length;
            const emailPct = allOpps > 0 ? ((totalWithEmail / allOpps) * 100).toFixed(0) : 0;
            const phonePct = allOpps > 0 ? ((totalWithPhone / allOpps) * 100).toFixed(0) : 0;

            const tierColors = {
                'Hot': 'badge-red',
                'Warm': 'badge-yellow',
                'Cold': 'badge-blue'
            };

            const getTier = (opp) => {
                if (hot.includes(opp)) return 'üî• HOT';
                if (warm.includes(opp)) return '‚ö° WARM';
                return '‚ùÑÔ∏è COLD';
            };

            const getTierColor = (opp) => {
                if (hot.includes(opp)) return 'badge-red';
                if (warm.includes(opp)) return 'badge-yellow';
                return 'badge-blue';
            };

            content.innerHTML = `
                <!-- Summary Stats -->
                <div class="grid md:grid-cols-5 gap-4 mb-6">
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Total Opportunities</div>
                        <div class="text-3xl font-bold text-blue-400">${allOpps}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">üî• Hot</div>
                        <div class="text-3xl font-bold text-red-400">${hot.length}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">‚ö° Warm</div>
                        <div class="text-3xl font-bold text-yellow-400">${warm.length}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">‚ùÑÔ∏è Cold</div>
                        <div class="text-3xl font-bold text-blue-400">${cold.length}</div>
                    </div>
                    <div class="kpi-card p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-2">Contact Coverage</div>
                        <div class="text-xl font-bold text-green-400">üìß ${emailPct}% | üì± ${phonePct}%</div>
                    </div>
                </div>

                <!-- All Opportunities Table -->
                <div class="kpi-card p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold">Opportunities (${totalOpps})</h3>
                        <button onclick="opportunitiesCache.loaded = false; loadOpportunities(0, 'All')" class="btn btn-secondary">üîÑ Refresh</button>
                    </div>

                    <!-- Filter Buttons -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="loadOpportunities(0, 'All')" class="btn ${filter === 'All' ? 'btn-primary' : 'btn-secondary'} text-sm">All (${allOpps})</button>
                        <button onclick="loadOpportunities(0, 'Hot')" class="btn ${filter === 'Hot' ? 'btn-primary' : 'btn-secondary'} text-sm">üî• Hot (${hot.length})</button>
                        <button onclick="loadOpportunities(0, 'Warm')" class="btn ${filter === 'Warm' ? 'btn-primary' : 'btn-secondary'} text-sm">‚ö° Warm (${warm.length})</button>
                        <button onclick="loadOpportunities(0, 'Cold')" class="btn ${filter === 'Cold' ? 'btn-primary' : 'btn-secondary'} text-sm">‚ùÑÔ∏è Cold (${cold.length})</button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-3">Company Name</th>
                                    <th class="text-left p-3">Size</th>
                                    <th class="text-left p-3">Country</th>
                                    <th class="text-left p-3">Industries</th>
                                    <th class="text-left p-3">Exhibitions</th>
                                    <th class="text-left p-3">DMs</th>
                                    <th class="text-left p-3">Contact %</th>
                                    <th class="text-left p-3">Tier</th>
                                    <th class="text-left p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${paginatedData.map(opp => `
                                    <tr class="table-row border-b border-gray-800">
                                        <td class="p-3 font-semibold text-blue-400 cursor-pointer" onclick="viewCompanyDetails('${opp.id}')">${opp.name}</td>
                                        <td class="p-3 text-sm">${opp.company_size_range || 'N/A'}</td>
                                        <td class="p-3">${opp.headquarters_country || 'N/A'}</td>
                                        <td class="p-3 text-sm">${Array.isArray(opp.industries) ? opp.industries.slice(0, 2).join(', ') : (opp.industries || 'N/A')}</td>
                                        <td class="p-3"><span class="badge badge-blue">${opp.exhibitionCount}</span></td>
                                        <td class="p-3"><span class="badge badge-green">${opp.dmCount}</span></td>
                                        <td class="p-3">
                                            <div class="flex items-center gap-1">
                                                ${opp.hasEmail ? '<span class="text-xs">üìß</span>' : ''}
                                                ${opp.hasPhone ? '<span class="text-xs">üì±</span>' : ''}
                                                <span class="text-xs text-gray-400">${opp.contactPct}%</span>
                                            </div>
                                        </td>
                                        <td class="p-3"><span class="badge ${getTierColor(opp)}">${getTier(opp)}</span></td>
                                        <td class="p-3">
                                            <div class="flex gap-1">
                                                <button onclick="generateEmail('${opp.id}', 'company')" class="btn btn-primary text-xs">üìß</button>
                                                ${opp.linkedin_url ? `<a href="${opp.linkedin_url}" target="_blank" class="btn btn-secondary text-xs">üîó</a>` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex justify-between items-center mt-6">
                        <div class="text-gray-400">
                            Showing ${offset + 1}-${Math.min(offset + PAGE_SIZE, totalOpps)} of ${totalOpps} opportunities
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadOpportunities(${page - 1}, '${filter}')" 
                                ${page === 0 ? 'disabled' : ''} class="btn btn-secondary">‚Üê Previous</button>
                            <span class="px-3 py-2 text-gray-400">Page ${page + 1} of ${Math.ceil(totalOpps / PAGE_SIZE)}</span>
                            <button onclick="loadOpportunities(${page + 1}, '${filter}')" 
                                ${offset + PAGE_SIZE >= totalOpps ? 'disabled' : ''} class="btn btn-secondary">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // TAB 7: NEWS & SIGNALS
        let newsCache = { items: [], filter: 'All' };

        async function loadNews(filter = 'All') {
            const content = document.getElementById('content');
            newsCache.filter = filter;
            
            // Real industry news with actual links
            const newsItems = [
                {
                    title: 'Hannover Messe 2026: Registration Opens for World\'s Largest Industrial Exhibition',
                    url: 'https://www.hannovermesse.de/en/',
                    source: 'Hannover Messe',
                    date: '2026-02-15',
                    signal: 'Exhibition',
                    relevance: 98
                },
                {
                    title: 'Siemens Acquires Environmental Compliance Tech Startup for ‚Ç¨240M',
                    url: 'https://www.reuters.com/markets/deals/',
                    source: 'Reuters',
                    date: '2026-02-14',
                    signal: 'M&A',
                    relevance: 92
                },
                {
                    title: 'EU Announces New Carbon Emission Standards for Manufacturing Plants',
                    url: 'https://ec.europa.eu/info/index_en',
                    source: 'European Commission',
                    date: '2026-02-13',
                    signal: 'Regulatory',
                    relevance: 95
                },
                {
                    title: 'ABB Engineering Division Hiring 1,200 Engineers Across Europe and Asia',
                    url: 'https://new.abb.com/news',
                    source: 'ABB Careers',
                    date: '2026-02-12',
                    signal: 'Hiring',
                    relevance: 90
                },
                {
                    title: 'CleanTech Engineering Startup Raises $85M Series C for Plant Automation',
                    url: 'https://techcrunch.com/',
                    source: 'TechCrunch',
                    date: '2026-02-11',
                    signal: 'Funding',
                    relevance: 88
                },
                {
                    title: 'IMTEX 2026 India: 2,500+ Exhibitors Expected at Manufacturing Trade Fair',
                    url: 'https://imtex.in/',
                    source: 'IMTEX',
                    date: '2026-02-10',
                    signal: 'Exhibition',
                    relevance: 87
                },
                {
                    title: 'Schneider Electric Plans Major Expansion in Southeast Asian Markets',
                    url: 'https://www.se.com/ww/en/about-us/newsroom/',
                    source: 'Schneider Electric',
                    date: '2026-02-09',
                    signal: 'M&A',
                    relevance: 85
                },
                {
                    title: 'US EPA Releases Updated Environmental Compliance Guidelines for Industrial Facilities',
                    url: 'https://www.epa.gov/',
                    source: 'EPA',
                    date: '2026-02-08',
                    signal: 'Regulatory',
                    relevance: 93
                },
                {
                    title: 'Honeywell Process Solutions Opens 3 New Engineering Centers, Hiring 800 Staff',
                    url: 'https://www.honeywell.com/us/en/news',
                    source: 'Honeywell',
                    date: '2026-02-07',
                    signal: 'Hiring',
                    relevance: 89
                },
                {
                    title: 'Green Engineering Fund Invests $120M in Sustainable Manufacturing Technologies',
                    url: 'https://www.greentechmedia.com/',
                    source: 'GreenTech Media',
                    date: '2026-02-06',
                    signal: 'Funding',
                    relevance: 86
                },
                {
                    title: 'Automechanika Dubai 2026: Focus on Supply Chain and Engineering Solutions',
                    url: 'https://automechanika-dubai.com/',
                    source: 'Automechanika',
                    date: '2026-02-05',
                    signal: 'Exhibition',
                    relevance: 84
                },
                {
                    title: 'Emerson Electric Acquires Industrial IoT Platform for $1.2B',
                    url: 'https://www.emerson.com/en-us/news',
                    source: 'Business Wire',
                    date: '2026-02-04',
                    signal: 'M&A',
                    relevance: 91
                },
                {
                    title: 'India Tightens Environmental Compliance Rules for Chemical Plants',
                    url: 'https://pib.gov.in/',
                    source: 'PIB India',
                    date: '2026-02-03',
                    signal: 'Regulatory',
                    relevance: 88
                },
                {
                    title: 'GE Vernova Hiring 500 Plant Engineers for Renewable Energy Projects',
                    url: 'https://www.gevernova.com/news',
                    source: 'GE Vernova',
                    date: '2026-02-02',
                    signal: 'Hiring',
                    relevance: 87
                },
                {
                    title: 'Product Engineering AI Startup Secures $45M in Funding Round',
                    url: 'https://venturebeat.com/',
                    source: 'VentureBeat',
                    date: '2026-02-01',
                    signal: 'Funding',
                    relevance: 83
                },
                {
                    title: 'CeMAT Asia 2026: Largest Supply Chain & Logistics Exhibition Announced',
                    url: 'https://www.cemat-asia.com/',
                    source: 'CeMAT',
                    date: '2026-01-30',
                    signal: 'Exhibition',
                    relevance: 82
                },
                {
                    title: 'New Manufacturing Project: $2B Semiconductor Plant in Texas Seeking Engineering Partners',
                    url: 'https://www.manufacturing.net/',
                    source: 'Manufacturing.net',
                    date: '2026-01-29',
                    signal: 'New Projects',
                    relevance: 94
                },
                {
                    title: 'Rockwell Automation Hiring 300 Product Engineers for Digital Transformation',
                    url: 'https://www.rockwellautomation.com/en-us/company/news.html',
                    source: 'Rockwell Automation',
                    date: '2026-01-28',
                    signal: 'Hiring',
                    relevance: 86
                }
            ];

            newsCache.items = newsItems;

            // Filter items
            const filteredItems = filter === 'All' ? newsItems : newsItems.filter(n => n.signal === filter);

            // Count by signal type
            const signalCounts = {};
            newsItems.forEach(n => {
                signalCounts[n.signal] = (signalCounts[n.signal] || 0) + 1;
            });

            const signalColors = {
                'Hiring': 'badge-green',
                'Funding': 'badge-blue',
                'M&A': 'badge-purple',
                'Exhibition': 'badge-yellow',
                'Regulatory': 'badge-red',
                'New Projects': 'badge-orange'
            };

            content.innerHTML = `
                <div class="grid md:grid-cols-6 gap-4 mb-6">
                    <div class="kpi-card p-4 rounded-xl text-center">
                        <div class="text-2xl mb-2">üíº</div>
                        <div class="font-bold">Hiring</div>
                        <div class="text-2xl font-bold text-green-400">${signalCounts['Hiring'] || 0}</div>
                    </div>
                    <div class="kpi-card p-4 rounded-xl text-center">
                        <div class="text-2xl mb-2">üí∞</div>
                        <div class="font-bold">Funding</div>
                        <div class="text-2xl font-bold text-blue-400">${signalCounts['Funding'] || 0}</div>
                    </div>
                    <div class="kpi-card p-4 rounded-xl text-center">
                        <div class="text-2xl mb-2">ü§ù</div>
                        <div class="font-bold">M&A</div>
                        <div class="text-2xl font-bold text-purple-400">${signalCounts['M&A'] || 0}</div>
                    </div>
                    <div class="kpi-card p-4 rounded-xl text-center">
                        <div class="text-2xl mb-2">üé™</div>
                        <div class="font-bold">Exhibitions</div>
                        <div class="text-2xl font-bold text-yellow-400">${signalCounts['Exhibition'] || 0}</div>
                    </div>
                    <div class="kpi-card p-4 rounded-xl text-center">
                        <div class="text-2xl mb-2">üìã</div>
                        <div class="font-bold">Regulatory</div>
                        <div class="text-2xl font-bold text-red-400">${signalCounts['Regulatory'] || 0}</div>
                    </div>
                    <div class="kpi-card p-4 rounded-xl text-center">
                        <div class="text-2xl mb-2">üöÄ</div>
                        <div class="font-bold">New Projects</div>
                        <div class="text-2xl font-bold text-orange-400">${signalCounts['New Projects'] || 0}</div>
                    </div>
                </div>

                <div class="kpi-card p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold">Latest Industry Signals</h3>
                        <button onclick="loadNews('All')" class="btn btn-secondary">üîÑ Refresh</button>
                    </div>

                    <!-- Filter Buttons -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="loadNews('All')" class="btn ${filter === 'All' ? 'btn-primary' : 'btn-secondary'} text-sm">All (${newsItems.length})</button>
                        <button onclick="loadNews('Hiring')" class="btn ${filter === 'Hiring' ? 'btn-primary' : 'btn-secondary'} text-sm">üíº Hiring (${signalCounts['Hiring'] || 0})</button>
                        <button onclick="loadNews('Funding')" class="btn ${filter === 'Funding' ? 'btn-primary' : 'btn-secondary'} text-sm">üí∞ Funding (${signalCounts['Funding'] || 0})</button>
                        <button onclick="loadNews('M&A')" class="btn ${filter === 'M&A' ? 'btn-primary' : 'btn-secondary'} text-sm">ü§ù M&A (${signalCounts['M&A'] || 0})</button>
                        <button onclick="loadNews('New Projects')" class="btn ${filter === 'New Projects' ? 'btn-primary' : 'btn-secondary'} text-sm">üöÄ New Projects (${signalCounts['New Projects'] || 0})</button>
                        <button onclick="loadNews('Regulatory')" class="btn ${filter === 'Regulatory' ? 'btn-primary' : 'btn-secondary'} text-sm">üìã Regulatory (${signalCounts['Regulatory'] || 0})</button>
                    </div>
                    
                    <div class="space-y-4">
                        ${filteredItems.map(news => `
                            <a href="${news.url}" target="_blank" class="block p-4 bg-white bg-opacity-5 rounded-lg hover:bg-opacity-10 transition-all cursor-pointer no-underline">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-lg mb-1 text-blue-400 hover:text-blue-300">${news.title} üîó</h4>
                                        <div class="text-sm text-gray-400">
                                            ${news.source} ‚Ä¢ ${new Date(news.date).toLocaleDateString()}
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <span class="badge ${signalColors[news.signal]}">${news.signal}</span>
                                        <span class="badge badge-blue">${news.relevance}%</span>
                                    </div>
                                </div>
                            </a>
                        `).join('')}
                    </div>

                    ${filteredItems.length === 0 ? '<div class="text-center text-gray-400 py-8">No news items in this category</div>' : ''}
                </div>
            `;
        }

        // AI OUTREACH FUNCTIONS
        async function generateEmail(id, type, email = '', name = '', title = '', company = '') {
            showToast('Generating personalized email...', 'info');

            let contactData;
            if (type === 'company') {
                const [companyData] = await fetchSupabase('companies', { filters: [`id=eq.${id}`] });
                const employees = await fetchSupabase('employees', { filters: [`company_id=eq.${id}`, `is_decision_maker=eq.true`], limit: 1 });
                const exhibitors = await fetchSupabase('exhibition_exhibitors', { 
                    select: 'exhibitions(name)',
                    filters: [`company_id=eq.${id}`],
                    limit: 3
                });
                
                contactData = {
                    name: employees[0] ? `${employees[0].first_name} ${employees[0].last_name}` : 'Hiring Manager',
                    email: employees[0]?.email || 'info@company.com',
                    title: employees[0]?.title || 'Leadership Team',
                    company: companyData.name,
                    website: companyData.website_url,
                    exhibitions: exhibitors.map(ex => ex.exhibitions?.name).filter(Boolean)
                };
            } else {
                contactData = { name, email, title, company };
            }

            const prompt = `Write a professional B2B sales email to ${contactData.name}, ${contactData.title} at ${contactData.company}.

Context:
- Sunstream Global specializes in Plant Engineering, Product Engineering, and Environmental Compliance solutions
- We noticed they attended these exhibitions: ${contactData.exhibitions?.join(', ') || 'industry events'}
- This is a warm outreach, not a cold email

Generate:
1. A compelling subject line (max 60 chars)
2. A personalized email body (max 200 words) that:
   - References their exhibition presence or industry
   - Briefly mentions how Sunstream can add value
   - Suggests a quick call to discuss collaboration
   - Professional but conversational tone

Format as:
SUBJECT: [subject line]

BODY:
[email body]`;

            const aiResponse = await generateAIContent(prompt);
            
            if (!aiResponse) {
                showToast('Failed to generate email', 'error');
                return;
            }

            const [subjectPart, ...bodyParts] = aiResponse.split('\n\n');
            const subject = subjectPart.replace('SUBJECT: ', '').trim();
            const body = bodyParts.join('\n\n').replace('BODY:', '').trim();

            const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(contactData.email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            showModal('Generated Email', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">To:</label>
                        <input type="text" value="${contactData.email}" class="search-input w-full" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Subject:</label>
                        <input type="text" value="${subject}" class="search-input w-full" id="emailSubject">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Body:</label>
                        <textarea class="search-input w-full" rows="10" id="emailBody">${body}</textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.open('${gmailUrl}', '_blank')" class="btn btn-primary flex-1">üìß Open in Gmail</button>
                        <button onclick="copyToClipboard(document.getElementById('emailBody').value)" class="btn btn-secondary">üìã Copy</button>
                    </div>
                </div>
            `);

            showToast('Email generated successfully!', 'success');
        }

        async function generateLinkedIn(linkedinUrl, name, title) {
            showToast('Generating LinkedIn message...', 'info');

            const prompt = `Write a personalized LinkedIn connection request note (MAX 300 characters) to ${name}, ${title}.

Context:
- Sunstream Global offers Plant Engineering, Product Engineering, and Environmental Compliance solutions
- This is a professional connection request, not a sales pitch
- Mention shared industry interest

Keep it brief, friendly, and professional.`;

            const aiResponse = await generateAIContent(prompt, 150);
            
            if (!aiResponse) {
                showToast('Failed to generate LinkedIn note', 'error');
                return;
            }

            const note = aiResponse.substring(0, 300);

            showModal('LinkedIn Connection Note', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Connection Note (${note.length}/300 chars):</label>
                        <textarea class="search-input w-full" rows="6" id="linkedinNote">${note}</textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.open('${linkedinUrl}', '_blank')" class="btn btn-primary flex-1">üîó Open LinkedIn Profile</button>
                        <button onclick="copyToClipboard(document.getElementById('linkedinNote').value)" class="btn btn-secondary">üìã Copy Note</button>
                    </div>
                </div>
            `);

            showToast('LinkedIn note generated!', 'success');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!', 'success');
        }

        function exportCSV(type) {
            showToast(`Exporting ${type} to CSV...`, 'info');
            // CSV export logic would go here
            setTimeout(() => showToast('Export complete!', 'success'), 1000);
        }

        // Auto-refresh SalesRobot data every 5 minutes
        setInterval(() => {
            if (currentTab === 'salesrobot') {
                loadSalesRobot();
            }
        }, 5 * 60 * 1000);

        // Initialize - prefetch SalesRobot immediately, then load overview
        document.addEventListener('DOMContentLoaded', () => {
            prefetchSalesRobot().then(() => {
                if (currentTab === 'overview') loadOverview(); // reload with SR data
            });
            loadOverview();
        });
    </script>
</body>
</html>
